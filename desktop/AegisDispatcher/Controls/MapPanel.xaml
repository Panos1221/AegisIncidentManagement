<UserControl x:Class="AegisDispatcher.Controls.MapPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
             xmlns:local="clr-namespace:AegisDispatcher.Controls"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="600">

    <UserControl.Resources>
        <Style x:Key="MapOverlayButton" TargetType="Button">
            <Setter Property="Background" Value="#CC2D2D30"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#FF626262"/>
            <Setter Property="Padding" Value="8"/>
            <Setter Property="Margin" Value="5"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="5"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" 
                                            VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#CC007ACC"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#CC005A9B"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Background" Value="#CC666666"/>
                                <Setter Property="Foreground" Value="#FFAAAAAA"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="CoordinateDisplay" TargetType="TextBlock">
            <Setter Property="Background" Value="#CC2D2D30"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontFamily" Value="Consolas"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Padding" Value="8,4"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <!-- Map Container -->
        <Border Background="#FF1E1E1E" CornerRadius="5">
            <Grid>
                <!-- WebView2 for OpenStreetMap -->
                <wv2:WebView2 x:Name="MapWebView" 
                              NavigationCompleted="MapWebView_NavigationCompleted"/>
                
                <!-- Fallback Map Display -->
                <Grid x:Name="FallbackMap" Visibility="Collapsed" Background="#FF2D2D30">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <TextBlock Text="ðŸ—ºï¸" FontSize="48" HorizontalAlignment="Center" Margin="0,0,0,10"/>
                    <TextBlock Text="Map View" Foreground="White" FontSize="16" FontWeight="SemiBold" 
                              HorizontalAlignment="Center"/>
                    <TextBlock Text="Interactive map with incident markers" Foreground="#FFCCCCCC" 
                              FontSize="12" HorizontalAlignment="Center" Margin="0,5,0,0"/>
                    <Button x:Name="RetryMapButton" Content="Retry Loading Map" 
                           Style="{StaticResource MapOverlayButton}" Margin="0,15,0,0"
                           Click="RetryMap_Click"/>
                </StackPanel>
            </Grid>

            <!-- Loading Overlay -->
            <Grid x:Name="MapLoadingOverlay" Background="#CC1E1E1E" Visibility="Visible">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <TextBlock Text="â—" Foreground="#FF007ACC" FontSize="24" 
                              HorizontalAlignment="Center" Margin="0,0,0,10">
                        <TextBlock.RenderTransform>
                            <RotateTransform x:Name="MapLoadingRotation"/>
                        </TextBlock.RenderTransform>
                    </TextBlock>
                    <TextBlock Text="Loading Map..." Foreground="White" FontSize="14" 
                              HorizontalAlignment="Center"/>
                    <TextBlock Text="Initializing OpenStreetMap view" Foreground="#FFCCCCCC" 
                              FontSize="11" HorizontalAlignment="Center" Margin="0,5,0,0"/>
                </StackPanel>
            </Grid>
            </Grid>
        </Border>

        <!-- Map Controls Overlay -->
        <StackPanel HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10">
            <!-- Zoom Controls -->
            <Button Content="+" Style="{StaticResource MapOverlayButton}" 
                   Click="ZoomIn_Click" FontSize="16" FontWeight="Bold"/>
            <Button Content="âˆ’" Style="{StaticResource MapOverlayButton}" 
                   Click="ZoomOut_Click" FontSize="16" FontWeight="Bold"/>
            

            
            <!-- Center on Incidents -->
            <Button Content="ðŸŽ¯" Style="{StaticResource MapOverlayButton}" 
                   Click="CenterOnIncidents_Click" ToolTip="Center on Active Incidents"/>
            
            <!-- My Location -->
            <Button Content="ðŸ“" Style="{StaticResource MapOverlayButton}" 
                   Click="ShowMyLocation_Click" ToolTip="Show My Location"/>
            
            <!-- Resources Toggle -->
            <Button Content="ðŸ—‚ï¸" Style="{StaticResource MapOverlayButton}" 
                   Click="ToggleResources_Click" ToolTip="Toggle Resources"/>
        </StackPanel>

        <!-- Resources Panel -->
        <Border x:Name="ResourcesPanel" 
                HorizontalAlignment="Right" 
                VerticalAlignment="Top" 
                Margin="10,200,10,10" 
                Background="#CC2D2D30" 
                BorderBrush="#FF626262" 
                BorderThickness="1" 
                CornerRadius="8" 
                Padding="12" 
                Visibility="Collapsed"
                MinWidth="200">
            <StackPanel>
                <TextBlock Text="Resources" 
                          Foreground="White" 
                          FontWeight="SemiBold" 
                          FontSize="14"
                          Margin="0,0,0,12"/>
                
                <!-- Common Resources -->
                <CheckBox x:Name="ShowIncidentsToggle" 
                         Content="ðŸš¨ Active Incidents" 
                         Foreground="White" 
                         IsChecked="True" 
                         Margin="0,4"
                         Checked="ResourceToggle_Changed" 
                         Unchecked="ResourceToggle_Changed"/>
                
                <CheckBox x:Name="ShowVehiclesToggle" 
                         Content="ðŸš› Vehicles" 
                         Foreground="White" 
                         IsChecked="True" 
                         Margin="0,4"
                         Checked="ResourceToggle_Changed" 
                         Unchecked="ResourceToggle_Changed"/>

                <!-- Agency-Specific Resources -->
                <StackPanel x:Name="AgencyResourcesPanel">
                    <!-- Fire Service Resources -->
                    <StackPanel x:Name="FireServiceResources" Visibility="Collapsed">
                        <Separator Background="#FF626262" Margin="0,8"/>
                        <TextBlock Text="Fire Service" 
                                  Foreground="#FFAAAAAA" 
                                  FontSize="12" 
                                  Margin="0,4,0,8"/>
                        
                        <CheckBox x:Name="ShowFireStationsToggle" 
                                 Content="ðŸ¢ Fire Stations" 
                                 Foreground="White" 
                                 IsChecked="True" 
                                 Margin="0,4"
                                 Checked="ResourceToggle_Changed" 
                                 Unchecked="ResourceToggle_Changed"/>
                        
                        <CheckBox x:Name="ShowFireHydrantsToggle" 
                                 Content="ðŸš° Fire Hydrants" 
                                 Foreground="White" 
                                 IsChecked="True" 
                                 Margin="0,4"
                                 Checked="ResourceToggle_Changed" 
                                 Unchecked="ResourceToggle_Changed"/>
                        
                        <CheckBox x:Name="ShowFireStationBoundariesToggle" 
                                 Content="ðŸ—ºï¸ Station Districts" 
                                 Foreground="White" 
                                 IsChecked="False" 
                                 Margin="0,4"
                                 Checked="ResourceToggle_Changed" 
                                 Unchecked="ResourceToggle_Changed"/>
                    </StackPanel>

                    <!-- Police Resources -->
                    <StackPanel x:Name="PoliceResources" Visibility="Collapsed">
                        <Separator Background="#FF626262" Margin="0,8"/>
                        <TextBlock Text="Police Service" 
                                  Foreground="#FFAAAAAA" 
                                  FontSize="12" 
                                  Margin="0,4,0,8"/>
                        
                        <CheckBox x:Name="ShowPoliceStationsToggle" 
                                 Content="ðŸ¢ Police Stations" 
                                 Foreground="White" 
                                 IsChecked="True" 
                                 Margin="0,4"
                                 Checked="ResourceToggle_Changed" 
                                 Unchecked="ResourceToggle_Changed"/>
                        
                        <CheckBox x:Name="ShowPatrolZonesToggle" 
                                 Content="ðŸ›¡ï¸ Patrol Zones" 
                                 Foreground="White" 
                                 IsChecked="True" 
                                 Margin="0,4"
                                 Checked="ResourceToggle_Changed" 
                                 Unchecked="ResourceToggle_Changed"/>
                    </StackPanel>

                    <!-- Coast Guard Resources -->
                    <StackPanel x:Name="CoastGuardResources" Visibility="Collapsed">
                        <Separator Background="#FF626262" Margin="0,8"/>
                        <TextBlock Text="Coast Guard Service" 
                                  Foreground="#FFAAAAAA" 
                                  FontSize="12" 
                                  Margin="0,4,0,8"/>
                        
                        <CheckBox x:Name="ShowCoastGuardStationsToggle" 
                                 Content="âš“ Coast Guard Stations" 
                                 Foreground="White" 
                                 IsChecked="True" 
                                 Margin="0,4"
                                 Checked="ResourceToggle_Changed" 
                                 Unchecked="ResourceToggle_Changed"/>
                        
                        <CheckBox x:Name="ShowShipsToggle" 
                                 Content="ðŸš¢ Vessels" 
                                 Foreground="White" 
                                 IsChecked="True" 
                                 Margin="0,4"
                                 Checked="ResourceToggle_Changed" 
                                 Unchecked="ResourceToggle_Changed"/>
                        
                        <CheckBox x:Name="ShowPatrolZonesCoastGuardToggle" 
                                 Content="ðŸ›¡ï¸ Patrol Zones" 
                                 Foreground="White" 
                                 IsChecked="True" 
                                 Margin="0,4"
                                 Checked="ResourceToggle_Changed" 
                                 Unchecked="ResourceToggle_Changed"/>
                    </StackPanel>

                    <!-- EKAB Resources -->
                    <StackPanel x:Name="EKABResources" Visibility="Collapsed">
                        <Separator Background="#FF626262" Margin="0,8"/>
                        <TextBlock Text="EKAB Service" 
                                  Foreground="#FFAAAAAA" 
                                  FontSize="12" 
                                  Margin="0,4,0,8"/>
                        
                        <CheckBox x:Name="ShowHospitalsToggle" 
                                 Content="ðŸ¥ Hospitals" 
                                 Foreground="White" 
                                 IsChecked="True" 
                                 Margin="0,4"
                                 Checked="ResourceToggle_Changed" 
                                 Unchecked="ResourceToggle_Changed"/>
                        
                        <CheckBox x:Name="ShowAmbulancesToggle" 
                                 Content="ðŸš‘ Ambulances" 
                                 Foreground="White" 
                                 IsChecked="True" 
                                 Margin="0,4"
                                 Checked="ResourceToggle_Changed" 
                                 Unchecked="ResourceToggle_Changed"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Coordinates Display -->
        <Border HorizontalAlignment="Left" VerticalAlignment="Bottom" Margin="10" 
                Background="#CC2D2D30" CornerRadius="3" BorderBrush="#FF626262" BorderThickness="1">
            <TextBlock x:Name="CoordinatesText" Style="{StaticResource CoordinateDisplay}"
                      Text="Lat: 0.000000, Lng: 0.000000"/>
        </Border>

        <!-- Context Menu Popup - Renders above WebView2 -->
        <Popup x:Name="ContextMenuPopup" 
               AllowsTransparency="True"
               StaysOpen="False"
               PopupAnimation="Fade"
               Placement="Absolute">
            <Border x:Name="MapContextMenu" Background="#FF2D2D30" BorderBrush="#FF626262"
                   BorderThickness="1" CornerRadius="5" Padding="5">
                <Border.Effect>
                    <DropShadowEffect Color="Black" Direction="315" ShadowDepth="5" Opacity="0.5" BlurRadius="10"/>
                </Border.Effect>
                <StackPanel MinWidth="150">
                    <Button Content="ðŸ“ Add Incident Here" Style="{StaticResource MapOverlayButton}"
                           Margin="0" Padding="10,8" HorizontalAlignment="Stretch"
                           Click="AddIncidentHere_Click"/>
                    <Button Content="ðŸš’ Assign Nearest Unit" Style="{StaticResource MapOverlayButton}"
                           Margin="0,2,0,0" Padding="10,8" HorizontalAlignment="Stretch"
                           Click="AssignNearestUnit_Click"/>
                    <Separator Background="#FF626262" Margin="0,5"/>
                    <TextBlock x:Name="ContextCoordinates" Text="Lat: 0.000, Lng: 0.000" 
                              Foreground="#FFCCCCCC" FontSize="10" Margin="10,5"/>
                </StackPanel>
            </Border>
        </Popup>

        <!-- Legend -->
        <Border x:Name="MapLegend" HorizontalAlignment="Left" VerticalAlignment="Top" 
               Margin="10" Background="#CC2D2D30" BorderBrush="#FF626262" 
               BorderThickness="1" CornerRadius="5" Padding="10">
            <StackPanel MinWidth="120">
                <TextBlock Text="Map Legend" Foreground="White" FontWeight="SemiBold" 
                          Margin="0,0,0,8"/>
                
                <StackPanel Orientation="Horizontal" Margin="0,2">
                    <Ellipse Width="12" Height="12" Fill="#FFDC3545" Margin="0,0,8,0"/>
                    <TextBlock Text="Active Incident" Foreground="#FFCCCCCC" FontSize="10"/>
                </StackPanel>
                
                <StackPanel Orientation="Horizontal" Margin="0,2">
                    <Ellipse Width="12" Height="12" Fill="#FF007ACC" Margin="0,0,8,0"/>
                    <TextBlock Text="Fire Station" Foreground="#FFCCCCCC" FontSize="10"/>
                </StackPanel>
                
                <StackPanel Orientation="Horizontal" Margin="0,2">
                    <Rectangle Width="12" Height="12" Fill="#FF28A745" Margin="0,0,8,0"/>
                    <TextBlock Text="Available Vehicle" Foreground="#FFCCCCCC" FontSize="10"/>
                </StackPanel>
                
                <StackPanel Orientation="Horizontal" Margin="0,2">
                    <Rectangle Width="12" Height="12" Fill="#FFFD7E14" Margin="0,0,8,0"/>
                    <TextBlock Text="En Route Vehicle" Foreground="#FFCCCCCC" FontSize="10"/>
                </StackPanel>
                
                <Button x:Name="ToggleLegendButton" Content="Hide Legend" 
                       Style="{StaticResource MapOverlayButton}" Margin="0,8,0,0"
                       Padding="5,3" FontSize="10" Click="ToggleLegend_Click"/>
            </StackPanel>
        </Border>

        </Grid>
</UserControl>
